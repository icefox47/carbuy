<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0f172a">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
    <title>Find Your Perfect Car</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <style>
        .hero-section {
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('static/img/hero-bg.jpg');
            background-size: cover;
            background-position: center;
            min-height: 80vh;
            display: flex;
            align-items: center;
        }

        .feature-card {
            transition: transform 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-10px);
        }

        .icon-circle {
            width: 80px;
            height: 80px;
            background-color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
        }

        .icon-circle i {
            font-size: 2rem;
            color: white;
        }

        /* Loader Overlay */
        #loaderOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            /* Darker, more solid background */
            backdrop-filter: blur(15px);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #loaderOverlay.active {
            display: flex;
            opacity: 1;
        }

        /* Loader Animation */
        .loader-content {
            text-align: center;
            color: white;
            background: rgba(255, 255, 255, 0.05);
            padding: 3rem;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .spinner-box {
            width: 80px;
            height: 80px;
            margin: 0 auto 2rem;
            position: relative;
        }

        .circle-border {
            width: 100%;
            height: 100%;
            padding: 3px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            background: linear-gradient(0deg, rgba(63, 249, 220, 0.1) 33%, #00d2ff 100%);
            /* Brighter cyan/blue */
            animation: spin 1s linear 0s infinite;
        }

        .circle-core {
            width: 100%;
            height: 100%;
            background-color: #0f172a;
            /* Matches overlay bg */
            border-radius: 50%;
        }

        @keyframes spin {
            from {
                transform: rotate(0);
            }

            to {
                transform: rotate(359deg);
            }
        }

        .loading-text {
            font-size: 1.8rem;
            font-weight: 600;
            letter-spacing: 1px;
            margin-top: 1rem;
            background: linear-gradient(to right, #fff, #00d2ff);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(0, 210, 255, 0.3);
        }

        .loading-subtext {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 0.8rem;
            font-weight: 400;
        }

        /* Mobile Responsiveness Tweaks */
        @media (max-width: 576px) {
            .loader-content {
                padding: 1.5rem;
                width: 90%;
            }

            .loading-text {
                font-size: 1.4rem;
            }

            .hero-section h1 {
                font-size: 2.5rem;
            }

            .search-card {
                padding: 1.5rem;
            }
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">CarFinder</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('index') }}">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#features">Features</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#how-it-works">How It Works</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link btn btn-primary ms-lg-3" href="{{ url_for('car_form') }}">Find Your Car</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section text-white">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <h1 class="display-3 mb-4 fw-bold">
                        Find Your <span class="gradient-highlight">Dream Car</span> with AI
                    </h1>
                    <p class="lead mb-5">Experience the future of car buying. Our AI-powered platform understands your
                        needs and matches you with the perfect vehicle. Luxury, simplicity, perfection.</p>
                </div>
                <div class="col-lg-5 offset-lg-1">
                    <div class="search-card">
                        <h3 class="text-dark mb-3"><i class="fas fa-robot me-2"></i>AI Car Match</h3>
                        <p class="text-muted mb-4">Describe your dream car in natural language. Our AI will understand
                            and find the perfect match for you.</p>
                        <div class="form-group mb-3">
                            <textarea class="form-control" id="aiQuery" rows="4"
                                placeholder="e.g., I need a luxury SUV under 100k AED with good fuel economy for my family..."></textarea>
                        </div>
                        <button type="button" class="btn btn-primary w-100 py-3" onclick="showUserForm()">
                            <i class="fas fa-magic me-2"></i>Find My Perfect Car
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- User Details Modal -->
    <div class="modal fade" id="userDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-circle me-2"></i>Almost There!</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-4">We need a few details to personalize your car recommendations and save your
                        preferences.</p>
                    <form id="userForm">
                        <div class="mb-4">
                            <label for="userName" class="form-label fw-semibold">Full Name</label>
                            <input type="text" class="form-control" id="userName" placeholder="John Doe" required>
                        </div>
                        <div class="mb-4">
                            <label for="userPhone" class="form-label fw-semibold">Phone Number</label>
                            <input type="tel" class="form-control" id="userPhone" placeholder="+971 50 123 4567"
                                required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitAIQuery()">
                        <i class="fas fa-sparkles me-2"></i>See My Matches
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Modal -->
    <div class="modal fade" id="resultsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-stars me-2"></i>Your Perfect Matches</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="aiCriteria" class="alert alert-info mb-4" style="display:none;">
                        <!-- Criteria will be injected here -->
                    </div>
                    <div id="resultsContainer" class="row g-4">
                        <!-- Results will be injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loader Overlay -->
    <div id="loaderOverlay">
        <div class="loader-content">
            <div class="spinner-box">
                <div class="circle-border">
                    <div class="circle-core"></div>
                </div>
            </div>
            <h3 class="loading-text">Consulting AI Expert...</h3>
            <p class="loading-subtext">Analyzing your preferences and market data</p>
        </div>
    </div>

    <script>
        let currentInquiryId = null;

        function showUserForm() {
            const query = document.getElementById('aiQuery').value;
            if (!query.trim()) {
                alert('Please describe the car you are looking for.');
                return;
            }
            const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
            modal.show();
        }

        async function submitAIQuery() {
            const query = document.getElementById('aiQuery').value;
            const name = document.getElementById('userName').value;
            const phone = document.getElementById('userPhone').value;

            if (!name || !phone) {
                alert('Please fill in all fields.');
                return;
            }

            // Close user modal
            const userModalEl = document.getElementById('userDetailsModal');
            const userModal = bootstrap.Modal.getInstance(userModalEl);
            userModal.hide();

            // Show loading state
            const loader = document.getElementById('loaderOverlay');
            loader.classList.add('active');

            try {
                const response = await fetch('/api/ai-search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        name: name,
                        phone: phone
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    currentInquiryId = result.inquiry_id; // Store inquiry ID
                    displayResults(result);
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while processing your request.');
            } finally {
                // Hide loading state
                loader.classList.remove('active');
            }
        }

        async function logInterest(carIndex, carData) {
            if (!currentInquiryId) return;

            const btn = document.getElementById(`btn-request-${carIndex}`);
            const originalText = btn.innerHTML;

            // Show loading state on button
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/log-interest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        inquiry_id: currentInquiryId,
                        car_details: carData
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    btn.innerHTML = '<i class="fas fa-check me-2"></i>Request Sent';
                    btn.classList.remove('btn-outline-primary');
                    btn.classList.add('btn-success', 'text-white');
                } else {
                    // Revert on error
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    alert('Could not log interest. Please try again.');
                }
            } catch (error) {
                console.error('Error logging interest:', error);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function displayResults(data) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';

            // Show user info and search query
            const criteriaDiv = document.getElementById('aiCriteria');
            if (data.user_info) {
                criteriaDiv.style.display = 'block';

                // Build criteria summary
                const parts = [];
                if (data.criteria.condition) parts.push(`<strong>${data.criteria.condition}</strong>`);
                if (data.criteria.make) parts.push(`<strong>${data.criteria.make}</strong>`);
                if (data.criteria.type) parts.push(`<strong>${data.criteria.type}</strong>`);
                if (data.criteria.year) parts.push(`year <strong>${data.criteria.year}</strong>`);
                if (data.criteria.fuel) parts.push(`<strong>${data.criteria.fuel}</strong> fuel`);
                if (data.criteria.transmission) parts.push(`<strong>${data.criteria.transmission}</strong> transmission`);
                if (data.criteria.budget) parts.push(`budget <strong>${data.criteria.budget}</strong>`);

                const criteriaText = parts.length > 0 ? parts.join(', ') : 'any preferences';

                criteriaDiv.innerHTML = `
                    <div class="mb-3">
                        <h6 class="mb-2"><i class="fas fa-user-circle me-2"></i>Your Search</h6>
                        <p class="mb-2"><strong>Name:</strong> ${data.user_info.name}</p>
                        <p class="mb-2"><strong>Query:</strong> "${data.user_info.original_query}"</p>
                        <p class="mb-0"><i class="fas fa-brain me-2"></i><strong>AI Understanding:</strong> We found ${criteriaText} based on your request.</p>
                    </div>
                    <div class="alert alert-success mt-3 border-0 shadow-sm">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-headset fa-2x me-3 text-success"></i>
                            <div>
                                <h6 class="alert-heading mb-1">We're on it!</h6>
                                <p class="mb-0">Our expert agent has received your request and will contact you shortly with the best deals matching these preferences.</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (data.recommendations && data.recommendations.length > 0) {
                data.recommendations.forEach((car, index) => {
                    // Get AI-generated description for this car
                    const aiDescription = data.descriptions && data.descriptions[index.toString()]
                        ? `<div class="mt-3 pt-3 border-top">
                             <div class="d-flex">
                                <i class="fas fa-quote-left text-primary opacity-25 me-2 fa-lg"></i>
                                <p class="mb-0 fst-italic text-muted small">${data.descriptions[index.toString()]}</p>
                             </div>
                           </div>`
                        : '';

                    // Escape car data for onclick
                    const carJson = JSON.stringify(car).replace(/"/g, '&quot;');

                    const carCard = `
                        <div class="col-md-6 col-lg-4" style="animation: fadeInUp 0.5s ease-out ${index * 0.1}s backwards;">
                            <div class="card h-100 border-0 shadow-sm hover-lift">
                                <div class="card-body p-4">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <span class="badge bg-primary bg-opacity-10 text-primary mb-2">${car.year}</span>
                                            <h4 class="card-title fw-bold mb-1">${car.make} ${car.model}</h4>
                                            <div class="text-muted small">${car.type ? car.type.toUpperCase() : 'CAR'}</div>
                                        </div>
                                        <div class="text-end">
                                            <div class="text-gradient fw-bold fs-4">AED ${car.price.toLocaleString()}</div>
                                            <small class="text-muted">Estimated Price</small>
                                        </div>
                                    </div>
                                    
                                    <div class="row g-2 mb-4">
                                        <div class="col-6">
                                            <div class="p-2 bg-light rounded">
                                                <i class="fas fa-gas-pump text-primary me-2"></i>
                                                <span class="small fw-semibold">${car.fuel}</span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="p-2 bg-light rounded">
                                                <i class="fas fa-cog text-primary me-2"></i>
                                                <span class="small fw-semibold">${car.transmission}</span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="p-2 bg-light rounded">
                                                <i class="fas fa-tag text-primary me-2"></i>
                                                <span class="small fw-semibold">${car.condition.toUpperCase()}</span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="p-2 bg-light rounded">
                                                <i class="fas fa-tachometer-alt text-primary me-2"></i>
                                                <span class="small fw-semibold">${car.kms_driven ? car.kms_driven.replace('_', '-') : 'N/A'}</span>
                                            </div>
                                        </div>
                                    </div>

                                    ${car.features ? `
                                        <div class="mb-3">
                                            <small class="text-uppercase text-muted fw-bold d-block mb-2" style="font-size: 0.75rem; letter-spacing: 1px;">Key Features</small>
                                            <div class="d-flex flex-wrap gap-2">
                                                ${car.features.slice(0, 4).map(f => `<span class="badge bg-light text-dark border">${f}</span>`).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                    ${aiDescription}
                                </div>
                                <div class="card-footer bg-white border-top-0 p-4 pt-0">
                                    <button id="btn-request-${index}" class="btn btn-outline-primary w-100" onclick="logInterest(${index}, ${carJson})">
                                        <i class="fas fa-phone me-2"></i>Request Details
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += carCard;
                });
            } else {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <p class="lead">No specific matches found, but we've saved your inquiry and will contact you soon with personalized options!</p>
                    </div>
                `;
            }

            const resultsModal = new bootstrap.Modal(document.getElementById('resultsModal'));
            resultsModal.show();
        }
    </script>

    <!-- Features Section -->
    <section id="features" class="py-5 bg-light">
        <div class="container">
            <h2 class="text-center mb-5">Why Choose Us</h2>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="card h-100 border-0 shadow-sm feature-card">
                        <div class="card-body text-center p-4">
                            <div class="icon-circle">
                                <i class="fas fa-handshake"></i>
                            </div>
                            <h4>Trusted Dealership Network</h4>
                            <p class="text-muted">Get access to quality cars from our partner dealerships you can trust.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 border-0 shadow-sm feature-card">
                        <div class="card-body text-center p-4">
                            <div class="icon-circle">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <h4>Best Price Guarantee</h4>
                            <p class="text-muted">We negotiate with dealers to get you the best possible deal.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 border-0 shadow-sm feature-card">
                        <div class="card-body text-center p-4">
                            <div class="icon-circle">
                                <i class="fas fa-user-friends"></i>
                            </div>
                            <h4>Personal Help</h4>
                            <p class="text-muted">Your own car expert guides you from start to finish.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- How It Works Section -->
    <section id="how-it-works" class="py-5">
        <div class="container">
            <h2 class="text-center mb-5">How It Works</h2>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="display-4 text-primary mb-3">1</div>
                        <h4>Tell Us What You Need</h4>
                        <p class="text-muted">Fill our simple form about your dream car and budget.</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="display-4 text-primary mb-3">2</div>
                        <h4>We Find the Best Options</h4>
                        <p class="text-muted">Our experts search the market for cars that match your needs.</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="display-4 text-primary mb-3">3</div>
                        <h4>We Connect You</h4>
                        <p class="text-muted">Get direct contact with dealers who have your perfect car.</p>
                    </div>
                </div>
            </div>

            <div class="text-center mt-5">
                <a href="{{ url_for('car_form') }}" class="btn btn-primary btn-lg">
                    Start Your Journey <i class="fas fa-arrow-right ms-2"></i>
                </a>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-dark text-white mt-5">
        <div class="container py-4 text-center">
            <p class="mb-3 mt-2">&copy; 2025 CarFinder. All rights reserved.</p>

            <a href="#">
                <i class="fa-brands fa-instagram m-3"></i>
            </a>
            <a href="#">
                <i class="fa-brands fa-facebook m-3"></i>
            </a>
            <a href="#">
                <i class="fa-brands fa-twitter m-3 "></i>
            </a>
            <a href="#">
                <i class="fa-brands fa-linkedin m-3 "></i>
            </a>
        </div>
    </footer>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>

</html>